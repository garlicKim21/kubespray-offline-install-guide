---
# =============================================================================
# ì˜¤í”„ë¼ì¸ ë¦¬ì†ŒìŠ¤ ì‚¬ì „ ê²€ì¦ Playbook
# =============================================================================
# 
# ì´ í”Œë ˆì´ë¶ì€ ì‹¤ì œ ë°°í¬ ì „ì— ë‹¤ìŒì„ ê²€ì¦í•©ë‹ˆë‹¤:
#   1. íŒŒì¼ ì„œë²„ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€
#   2. í•„ìˆ˜ ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
#   3. ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€
#   4. í•„ìˆ˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€
#
# -----------------------------------------------------------------------------
# ì‚¬ìš©ë²•:
# -----------------------------------------------------------------------------
#
# ê¸°ë³¸ ì‹¤í–‰ (ê¸°ë³¸ê°’ ì‚¬ìš©):
#   ansible-playbook playbooks/verify-offline-resources.yml
#
# Kubernetes ë²„ì „ ì§€ì •:
#   ansible-playbook playbooks/verify-offline-resources.yml \
#     -e kube_version=1.33.7
#
# ëª¨ë“  ë³€ìˆ˜ ì»¤ìŠ¤í…€:
#   ansible-playbook playbooks/verify-offline-resources.yml \
#     -e files_repo=http://192.168.1.100:8080 \
#     -e kubespray_version=v2.29.1 \
#     -e kube_version=1.33.7
#
# custom-config.ymlì—ì„œ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°:
#   ansible-playbook playbooks/verify-offline-resources.yml \
#     -e @sources/kubespray/kubespray-2.29.1/inventory/offline-test/custom-config.yml \
#     -e kube_version=1.33.7
#
# ì°¸ê³ : ì´ í”Œë ˆì´ë¶ì€ localhostì—ì„œë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ -i ì˜µì…˜(ì¸ë²¤í† ë¦¬)ì€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.
# =============================================================================

- name: "Verify Offline Resources"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # custom-config.ymlì—ì„œ ì˜¤ë²„ë¼ì´ë“œë¨
    files_repo: "http://192.168.108.201:8080"
    kubespray_version: "v2.29.1"
    kube_version: "1.33.7"
    
    # ê²€ì¦í•  í•„ìˆ˜ ë°”ì´ë„ˆë¦¬ ëª©ë¡
    required_binaries:
      - name: kubeadm
        url: "{{ files_repo }}/{{ kubespray_version }}/dl.k8s.io/release/v{{ kube_version }}/bin/linux/amd64/kubeadm"
      - name: kubelet
        url: "{{ files_repo }}/{{ kubespray_version }}/dl.k8s.io/release/v{{ kube_version }}/bin/linux/amd64/kubelet"
      - name: kubectl
        url: "{{ files_repo }}/{{ kubespray_version }}/dl.k8s.io/release/v{{ kube_version }}/bin/linux/amd64/kubectl"
    
    # ê²€ì¦í•  ë ˆì§€ìŠ¤íŠ¸ë¦¬ ëª©ë¡
    registries_to_check:
      - name: "Docker Hub Mirror"
        url: "http://repo.kubespray.miribit.lab:5000/v2/_catalog"
      - name: "Quay.io Mirror"
        url: "http://repo.kubespray.miribit.lab:5001/v2/_catalog"
      - name: "GHCR Mirror"
        url: "http://repo.kubespray.miribit.lab:5002/v2/_catalog"
      - name: "registry.k8s.io Mirror"
        url: "http://repo.kubespray.miribit.lab:5003/v2/_catalog"

  tasks:
    # =========================================================================
    # Step 1: íŒŒì¼ ì„œë²„ ì ‘ê·¼ í™•ì¸
    # =========================================================================
    - name: "[1/4] Check file server accessibility"
      uri:
        url: "{{ files_repo }}"
        method: HEAD
        timeout: 10
      register: file_server_check
      failed_when: false
      tags: [files]

    - name: "[1/4] File server status"
      debug:
        msg: "{{ 'âœ… File server accessible' if file_server_check.status == 200 else 'âŒ File server NOT accessible: ' + (file_server_check.msg | default('unknown error')) }}"
      tags: [files]

    # =========================================================================
    # Step 2: í•„ìˆ˜ ë°”ì´ë„ˆë¦¬ íŒŒì¼ í™•ì¸
    # =========================================================================
    - name: "[2/4] Check required binary files"
      uri:
        url: "{{ item.url }}"
        method: HEAD
        timeout: 30
      loop: "{{ required_binaries }}"
      loop_control:
        label: "{{ item.name }}"
      register: binary_checks
      failed_when: false
      tags: [files, binaries]

    - name: "[2/4] Binary files status"
      debug:
        msg: >-
          {{ item.item.name }}:
          {{ 'âœ… Available' if item.status == 200 else 'âŒ NOT FOUND (' + (item.status | string) + ')' }}
          - {{ item.item.url }}
      loop: "{{ binary_checks.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      tags: [files, binaries]

    # =========================================================================
    # Step 3: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ê·¼ í™•ì¸
    # =========================================================================
    - name: "[3/4] Check container registries"
      uri:
        url: "{{ item.url }}"
        method: GET
        timeout: 10
      loop: "{{ registries_to_check }}"
      loop_control:
        label: "{{ item.name }}"
      register: registry_checks
      failed_when: false
      tags: [images, registries]

    - name: "[3/4] Registry status"
      debug:
        msg: >-
          {{ item.item.name }}:
          {{ 'âœ… Accessible' if item.status == 200 else 'âŒ NOT accessible (' + (item.status | string | default('connection failed')) + ')' }}
      loop: "{{ registry_checks.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      tags: [images, registries]

    # =========================================================================
    # Step 4: í•„ìˆ˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ í™•ì¸ (registry.k8s.io)
    # =========================================================================
    - name: "[4/4] Check core Kubernetes images in registry"
      uri:
        url: "http://repo.kubespray.miribit.lab:5003/v2/kube-apiserver/tags/list"
        method: GET
        timeout: 10
      register: apiserver_tags
      failed_when: false
      tags: [images]

    - name: "[4/4] Parse kube-apiserver tags"
      set_fact:
        apiserver_has_version: "{{ ('v' + kube_version) in (apiserver_tags.json.tags | default([])) }}"
      when: apiserver_tags.status == 200
      tags: [images]

    - name: "[4/4] Kubernetes images status"
      debug:
        msg: >-
          kube-apiserver:v{{ kube_version }}:
          {{ 'âœ… Available' if apiserver_has_version | default(false) else 'âŒ NOT FOUND - Check if images are cached in registry' }}
      tags: [images]

    # =========================================================================
    # Summary
    # =========================================================================
    - name: "=== VERIFICATION SUMMARY ==="
      debug:
        msg:
          - "=============================================="
          - "       OFFLINE RESOURCE VERIFICATION"
          - "=============================================="
          - ""
          - "Kubespray Version: {{ kubespray_version }}"
          - "Kubernetes Version: v{{ kube_version }}"
          - ""
          - "File Server: {{ files_repo }}"
          - "  Status: {{ 'âœ… OK' if file_server_check.status == 200 else 'âŒ FAILED' }}"
          - ""
          - "Binary Files:"
          - "{% for item in binary_checks.results %}  - {{ item.item.name }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }}\n{% endfor %}"
          - "Container Registries:"
          - "{% for item in registry_checks.results %}  - {{ item.item.name }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }}\n{% endfor %}"
          - ""
          - "{{ 'ğŸ‰ All resources verified! Ready for deployment.' if (file_server_check.status == 200 and binary_checks.results | selectattr('status', 'equalto', 200) | list | length == required_binaries | length) else 'âš ï¸  Some resources are missing. Please check before deployment.' }}"
          - "=============================================="
      tags: [always]

